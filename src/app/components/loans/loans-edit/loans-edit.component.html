<form [formGroup]="loanForm" (ngSubmit)="saveLoan()">
  <div class="border-0 rounded-4 shadow-lg bg-white overflow-hidden">
    <div
      class="d-flex justify-content-between align-items-center px-4 py-3 border-bottom bg-primary-subtle"
    >
      <div class="p-2 d-flex align-items-center gap-2">
        <i class="fa-solid fa-pen-to-square fs-4 text-primary"></i>
        <h5 class="mb-0 fw-bold text-primary">Editar empréstimo</h5>
      </div>

      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="dialogRef.close()"
      ></button>
    </div>

    <div class="px-4 py-4" #dropdownContainer>
      <div class="mb-3 position-relative">
        <div class="small text-secondary fw-semibold mb-1">Livro</div>

        <input
          type="text"
          class="form-control form-control-lg fw-semibold"
          placeholder="Pesquisar livro"
          [formControl]="bookSearchControl"
          (focus)="openDropdown()"
        />

        @if (showDropdown) {
        <ul
          class="list-group position-absolute start-0 w-100 shadow rounded-3 mt-1 z-3"
          style="max-height: 240px; overflow-y: auto"
        >
          @if (filteredBooks.length === 0) {
          <li class="list-group-item text-secondary">
            Nenhum livro encontrado
          </li>
          } @for (book of filteredBooks; track book.id) {
          <li
            class="list-group-item list-group-item-action fw-semibold"
            (click)="selectBook(book)"
          >
            {{ book.title }}
          </li>
          }
        </ul>
        }
      </div>

      <div class="mb-3">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-secondary fw-semibold mb-1">
              Nome da Pessoa
            </div>
            <input
              class="form-control form-control-lg fw-semibold"
              type="text"
              formControlName="personName"
            />
          </div>

          <div class="col-md-6">
            <div class="small text-secondary fw-semibold mb-1">
              Data de empréstimo
            </div>
            <input
              class="form-control form-control-lg fw-semibold"
              type="text"
              formControlName="loanDate"
              placeholder="dd/MM/aaaa"
              mask="00/00/0000"
              [showMaskTyped]="true"
              [dropSpecialCharacters]="false"
              inputmode="numeric"
            />
            @if (loanForm.get('loanDate')?.errors?.['apiError']) {
            <div class="text-danger small mt-1">
              {{ loanForm.get('loanDate')?.errors?.['apiError'] }}
            </div>
            }
          </div>
        </div>
      </div>

      <div class="rounded-3 border bg-white p-3">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-secondary mb-1">Retorno esperado</div>
            <input
              type="text"
              class="form-control form-control-lg fw-semibold"
              formControlName="expectedReturnBook"
              placeholder="dd/MM/aaaa"
              mask="00/00/0000"
              [showMaskTyped]="true"
              [dropSpecialCharacters]="false"
              inputmode="numeric"
            />
            @if (loanForm.get('expectedReturnBook')?.errors?.['apiError']) {
            <div class="text-danger small mt-1">
              {{ loanForm.get('expectedReturnBook')?.errors?.['apiError'] }}
            </div>
            }
          </div>

          <div class="col-md-6">
            <div class="small text-secondary mb-1">Retorno realizado</div>
            <input
              type="text"
              class="form-control form-control-lg fw-semibold"
              formControlName="returnDate"
              placeholder="dd/MM/aaaa"
              mask="00/00/0000"
              [showMaskTyped]="true"
              [dropSpecialCharacters]="false"
              inputmode="numeric"
            />
            @if (loanForm.get('returnDate')?.errors?.['apiError']) {
            <div class="text-danger small mt-1">
              {{ loanForm.get('returnDate')?.errors?.['apiError'] }}
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <div
      class="d-flex justify-content-end px-4 py-3 border-top bg-primary-subtle"
    >
      <button type="button" class="btn btn-light px-4 me-2" (click)="cancel()">
        Cancelar
      </button>
      <button
        type="submit"
        class="btn btn-primary px-4"
        [disabled]="loanForm.invalid || loading"
      >
        {{ loading ? "Salvando..." : "Salvar" }}
      </button>
    </div>
  </div>
</form>
